#!/usr/bin/env zsh

# Load colors module for script output
autoload -Uz colors && colors

#################
# ANSI Constants
#################

# Basic formatting (these are what we're testing, not for script output)
typeset -gr RESET=$reset_color
typeset -gr BOLD=$'\033[1m'
typeset -gr DIM=$'\033[2m'
typeset -gr ITALIC=$'\033[3m'
typeset -gr UNDERLINE=$'\033[4m'
typeset -gr STRIKETHROUGH=$'\033[9m'
typeset -gr CONCEAL=$'\033[8m'
typeset -gr REVERSE=$'\033[7m'
typeset -gr BLINK=$'\033[5m'

# Extended underline styles (Smulx)
typeset -gr UNDERLINE_SINGLE=$'\033[4:1m'
typeset -gr UNDERLINE_DOUBLE=$'\033[4:2m'
typeset -gr UNDERLINE_CURLY=$'\033[4:3m'    # Also called undercurl
typeset -gr UNDERLINE_DOTTED=$'\033[4:4m'
typeset -gr UNDERLINE_DASHED=$'\033[4:5m'

# RGB color codes
# Format: \033[38;2;R;G;Bm for foreground, \033[48;2;R;G;Bm for background
typeset -gr RGB_FG_PREFIX=$'\033[38;2;'
typeset -gr RGB_BG_PREFIX=$'\033[48;2;'

# Display formatting
typeset -gr LABEL_WIDTH=20

# Track statistics
typeset -gi TPUT_SUCCESS=0
typeset -gi TPUT_FALLBACK=0
typeset -gi TPUT_FAILED=0

####################
# Capability Definitions
####################

# Standard terminal capabilities
# Each entry: capability_name => (tput_cap tput_arg fallback_seq)
typeset -gA CAPABILITIES
CAPABILITIES=(
  bold        "bold||$BOLD"
  dim         "dim||$DIM"
  italic      "sitm||$ITALIC"
  underline   "smul||$UNDERLINE"
  strikethrough "smxx||$STRIKETHROUGH"
  conceal     "invis||$CONCEAL"
  reverse     "rev||$REVERSE"
  blink       "blink||$BLINK"
)

# Smulx underline styles: 1=single, 2=double, 3=curly/undercurl, 4=dotted, 5=dashed
typeset -gA UNDERLINE_STYLES
UNDERLINE_STYLES=(
  single    "Smulx|1|$UNDERLINE_SINGLE"
  double    "Smulx|2|$UNDERLINE_DOUBLE"
  undercurl "Smulx|3|$UNDERLINE_CURLY"
  dotted    "Smulx|4|$UNDERLINE_DOTTED"
  dashed    "Smulx|5|$UNDERLINE_DASHED"
)

####################
# Helper Functions
####################

# Unified capability printer
# $1 = capability name (display name)
# $2 = pipe-delimited string: tput_cap|tput_arg|fallback_ansi
# $3 = optional custom format string (default: "Sample Text")
print_capability() {
  local name=$1
  local spec=$2
  local custom_text=$3

  local -a parts
  parts=("${(@s:|:)spec}")
  local tput_cap=${parts[1]}
  local tput_arg=${parts[2]}
  local fallback=${parts[3]}

  local seq tput_seq status_msg=""

  # Try tput first
  if command -v tput &>/dev/null && [[ -n $tput_cap ]]; then
    if [[ -n $tput_arg ]]; then
      tput_seq=$(tput "$tput_cap" "$tput_arg" 2>/dev/null)
    else
      tput_seq=$(tput "$tput_cap" 2>/dev/null)
    fi
  fi

  # Determine what to use and track statistics
  if [[ -n $tput_seq ]]; then
    seq=$tput_seq
    status_msg=""
    ((TPUT_SUCCESS++))
  elif [[ -n $fallback ]]; then
    seq=$fallback
    status_msg=" %F{242}(not in terminfo, using fallback)%f"
    ((TPUT_FALLBACK++))
  else
    seq=""
    ((TPUT_FAILED++))
  fi

  if [[ -n $seq ]]; then
    if [[ -n $custom_text ]]; then
      printf "%-${LABEL_WIDTH}s: %s%s%s" "$name" "$seq" "$custom_text" "$RESET"
      print -P "$status_msg"
    else
      printf "%-${LABEL_WIDTH}s: %sSample Text%s" "$name" "$seq" "$RESET"
      print -P "$status_msg"
    fi
  else
    printf "%-${LABEL_WIDTH}s: " "$name"
    print -P "%F{242}Not supported%f"
  fi
}

####################
# Display Functions
####################

show_env_info() {
  print -P "%B--- Environment Information --- %b"
  printf "%-${LABEL_WIDTH}s: %s\n" "TERM" "${TERM:-<not set>}"
  printf "%-${LABEL_WIDTH}s: %s\n" "TERM_PROGRAM" "${TERM_PROGRAM:-<not set>}"
  printf "%-${LABEL_WIDTH}s: %s\n" "COLORTERM" "${COLORTERM:-<not set>}"
  printf "%-${LABEL_WIDTH}s: %s\n" "In tmux" "${TMUX:+yes}"
  printf "%-${LABEL_WIDTH}s: %s\n" "In SSH" "${SSH_TTY:+yes}"
  if [[ -n "$TMUX" ]]; then
    local outer_term=$(tmux show-environment TERM_PROGRAM 2>/dev/null | cut -d= -f2)
    printf "%-${LABEL_WIDTH}s: %s\n" "Outer TERM_PROGRAM" "${outer_term:-<unknown>}"
  fi
  echo
}

show_standard_caps() {
  print -P "%B--- Terminal Capabilities --- %b\n"
  # Iterate over associative array in key order
  for name in ${(ko)CAPABILITIES}; do
    print_capability "$name" "${CAPABILITIES[$name]}"
  done
}

show_underline_styles() {
  print -P "\n%B--- Smulx Underline Styles --- %b"
  # Iterate over associative array in key order
  for name in ${(ko)UNDERLINE_STYLES}; do
    print_capability "$name" "${UNDERLINE_STYLES[$name]}" "This is $name"
  done
}

show_truecolor() {
  print -P "\n%B--- Truecolor Gradient --- %b"
  for i in {0..255..16}; do
    printf "${RGB_BG_PREFIX}%d;%d;%dm " $i $((255-i)) $((i/2))
  done
  printf "%s\n" $RESET
}

show_hyperlinks() {
  print -P "\n%B--- Hyperlink Support (OSC 8) --- %b"
  # OSC 8 hyperlinks: \e]8;;URL\e\\ starts link, \e]8;;\e\\ ends it
  # Use $'...' quoting so \e\\ is properly interpreted as ESC + backslash (ST character)
  # rather than having printf try to parse it from the format string
  local hyperlink_start=$'\e]8;;https://github.com\e\\'
  local hyperlink_end=$'\e]8;;\e\\'
  printf "%-${LABEL_WIDTH}s: %s%s%s%s\n" "Hyperlink test" "$hyperlink_start" "${UNDERLINE}GitHub Link${RESET}" "$hyperlink_end"
  printf "%-${LABEL_WIDTH}s: Should be clickable (hold Cmd/Ctrl to click)\n" "Expected"
  printf "%-${LABEL_WIDTH}s: Check 'link-url' setting in ghostty config\n" "Note"
}

show_colored_underlines() {
  print -P "\n%B--- Colored Double Underline & Undercurl --- %b"
  for i in {0..255..32}; do
    local fg="${RGB_FG_PREFIX}${i};0;255m"
    printf "${fg}${UNDERLINE_DOUBLE}Double %03d${RESET} " $i
    printf "${fg}${UNDERLINE_CURLY}Undercurl %03d${RESET}\n" $i
  done
}

check_tmux_passthrough() {
  if [[ -n "$TMUX" ]]; then
    print -P "\n%B--- Tmux Passthrough Check --- %b"

    printf "%-${LABEL_WIDTH}s: %sThis should be struck through%s\n" "Strikethrough test" "$STRIKETHROUGH" "$RESET"
    printf "%-${LABEL_WIDTH}s: %sThis should have curly underline%s\n" "Undercurl test" "$UNDERLINE_CURLY" "$RESET"

    printf "\nIf the above show effects, tmux passthrough is working.\n"
    printf "If not, add to tmux.conf:\n"
    printf "  set -as terminal-features ',*:strikethrough:usstyle'\n"
  fi
}

show_summary() {
  print -P "\n%B--- Summary --- %b"
  local -i total=$((TPUT_SUCCESS + TPUT_FALLBACK + TPUT_FAILED))

  printf "%-${LABEL_WIDTH}s: %d/%d\n" "Found in terminfo" "$TPUT_SUCCESS" "$total"
  printf "%-${LABEL_WIDTH}s: %d/%d\n" "Using fallback" "$TPUT_FALLBACK" "$total"
  printf "%-${LABEL_WIDTH}s: %d/%d\n" "Not supported" "$TPUT_FAILED" "$total"

  echo
  if [[ $TPUT_FALLBACK -gt 0 ]]; then
    print -P "%F{242}Note: Fallback sequences may still render correctly even if not in terminfo.%f"
  fi

  if [[ -n "$TMUX" && $TPUT_FALLBACK -gt 0 ]]; then
    print -P "%F{242}Tip: Extended features require terminal-features in tmux.conf%f"
  fi
}

####################
# Main Execution
####################

show_env_info
show_standard_caps
show_underline_styles
show_truecolor
show_hyperlinks
show_colored_underlines
check_tmux_passthrough
show_summary
